
<script>
(function () {
  /* ========== CONFIGURACI√ìN ========== */
  // üëâ Tu Web App (URL /exec de la nueva implementaci√≥n)
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXTxp8tNTtq5AcTtYINxwgW4184AR3QXhXDtaEAG2_kATnvWGjW7zKCLdEIkTPTBJWuA/exec';

  // (Opcional) ID de tu Google Sheet para exportar a XLSX.
  // Si no lo conoces a√∫n, deja vac√≠o; el env√≠o funciona igual.
  const SHEET_ID = ''; // Ej.: '1AbCDEF...xyz'

  /* ========== UTILIDADES ========== */
  // Encuentra un campo por el texto exacto del <label>
  function getFieldByLabel(formEl, labelText) {
    const labels = formEl.querySelectorAll('label');
    for (const label of labels) {
      const txt = (label.textContent || '').trim();
      if (txt === labelText) {
        const forId = label.getAttribute('for');
        if (forId) {
          const el = formEl.querySelector('#' + CSS.escape(forId));
          if (el) return el;
        }
        // Si no hay "for", toma el control que est√© justo despu√©s
        const next = label.nextElementSibling;
        if (next && next.matches('input, textarea, select')) return next;
        if (next) {
          const el = next.querySelector('input, textarea, select');
          if (el) return el;
        }
      }
    }
    return null;
  }

  // Normaliza claves (por si tu backend las usa as√≠)
  function normalizeKey(text) {
    return text
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // quita tildes
      .toLowerCase().replace(/[^a-z0-9]+/g, '_')        // espacios ‚Üí _
      .replace(/^_+|_+$/g, '');
  }

  // Construye payload preservando r√≥tulos originales y claves normalizadas
  function collectPayload(formEl, labelList) {
    const labelsObj = {};
    const dataObj   = {};
    for (const L of labelList) {
      const field = getFieldByLabel(formEl, L);
      const val   = field ? String(field.value || '').trim() : '';
      labelsObj[L] = val;
      dataObj[normalizeKey(L)] = val;
    }
    // Campos con atributo name que no tengan <label> (por si los tienes)
    formEl.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
      const n = el.getAttribute('name');
      if (n && !(n in labelsObj)) labelsObj[n] = String(el.value || '').trim();
    });
    return { labels: labelsObj, data: dataObj };
  }

  // ‚úÖ Validaciones seg√∫n tus reglas
  function validarCampos(formEl) {
    const get = (t) => (getFieldByLabel(formEl, t) || { value: '' }).value.trim();

    const numeroPortar = get('N√∫mero a portar');
    const cedula       = get('C√©dula');
    const nombre       = get('Nombre Completo');
    const direccion    = get('Direcci√≥n Completa');
    const barrio       = get('Barrio');
    const ciudad       = get('Ciudad');
    const departamento = get('Departamento');
    const ventana      = get('Ventana de Cambio (dd/mm/aaaa)');
    const iccid        = get('ICCID (20 d√≠gitos y debe iniciar con 8957101)');
    const contacto     = get('# DE CONTACTO');

    // N√∫mero a portar: 10 d√≠gitos y num√©rico
    if (!/^\d{10}$/.test(numeroPortar)) {
      alert('N√∫mero a portar inv√°lido: debe ser num√©rico y de 10 d√≠gitos.');
      (getFieldByLabel(formEl, 'N√∫mero a portar') || {}).focus?.();
      return false;
    }
    // C√©dula: solo n√∫meros
    if (!/^\d+$/.test(cedula)) {
      alert('C√©dula inv√°lida: solo n√∫meros.');
      (getFieldByLabel(formEl, 'C√©dula') || {}).focus?.();
      return false;
    }
    // Nombre: letras y espacios (con tildes)
    if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$/.test(nombre)) {
      alert('Nombre inv√°lido: solo letras y espacios.');
      (getFieldByLabel(formEl, 'Nombre Completo') || {}).focus?.();
      return false;
    }
    // Direcci√≥n: alfanum√©rica y s√≠mbolos permitidos # - . /
    if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±0-9#\-\./\/ ]+$/.test(direccion)) {
      alert('Direcci√≥n inv√°lida: usa letras, n√∫meros y # - . /.');
      (getFieldByLabel(formEl, 'Direcci√≥n Completa') || {}).focus?.();
      return false;
    }
    // Barrio: alfanum√©rico
    if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±0-9 ]+$/.test(barrio)) {
      alert('Barrio inv√°lido: usa letras y n√∫meros.');
      (getFieldByLabel(formEl, 'Barrio') || {}).focus?.();
      return false;
    }
    // Ciudad / Departamento: letras y espacios
    if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$/.test(ciudad)) {
      alert('Ciudad inv√°lida: usa solo letras y espacios.');
      (getFieldByLabel(formEl, 'Ciudad') || {}).focus?.();
      return false;
    }
    if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$/.test(departamento)) {
      alert('Departamento inv√°lido: usa solo letras y espacios.');
      (getFieldByLabel(formEl, 'Departamento') || {}).focus?.();
      return false;
    }
    // Ventana de Cambio: dd/mm/aaaa
    if (!/^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/\d{4}$/.test(ventana)) {
      alert('Ventana de Cambio inv√°lida: usa formato dd/mm/aaaa.');
      (getFieldByLabel(formEl, 'Ventana de Cambio (dd/mm/aaaa)') || {}).focus?.();
      return false;
    }
    // ICCID: 20 d√≠gitos y empieza con 8957101
    if (!/^8957101\d{13}$/.test(iccid)) {
      alert('ICCID inv√°lido: debe iniciar con 8957101 y tener 20 d√≠gitos.');
      (getFieldByLabel(formEl, 'ICCID (20 d√≠gitos y debe iniciar con 8957101)') || {}).focus?.();
      return false;
    }
    // # de contacto: 10 d√≠gitos, distinto al n√∫mero a portar
    if (!/^\d{10}$/.test(contacto)) {
      alert('# de contacto inv√°lido: debe ser num√©rico y de 10 d√≠gitos.');
      (getFieldByLabel(formEl, '# DE CONTACTO') || {}).focus?.();
      return false;
    }
    if (contacto === numeroPortar) {
      alert('# de contacto debe ser distinto al N√∫mero a portar.');
      (getFieldByLabel(formEl, '# DE CONTACTO') || {}).focus?.();
      return false;
    }
    return true;
  }

  /* ========== ENV√çO (sin tocar tu dise√±o) ========== */
  const form = document.querySelector('form'); // primer formulario de la p√°gina
  if (!form) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validaciones del navegador + tus reglas
    if (form.checkValidity && !form.checkValidity()) {
      form.reportValidity && form.reportValidity();
      return;
    }
    if (!validarCampos(form)) return;

    // Campos tal cual tus r√≥tulos (PAR√ÅMETROS originales)
    const CAMPOS = [
      'N√∫mero a portar',
      'C√©dula',
      'Nombre Completo',
      'Direcci√≥n Completa',
      'Barrio',
      'Ciudad',
      'Departamento',
      'Ventana de Cambio (dd/mm/aaaa)',
      'ICCID (20 d√≠gitos y debe iniciar con 8957101)',
      '# DE CONTACTO',
      'Observaciones'
    ];
    const payload = collectPayload(form, CAMPOS);

    try {
      const resp = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // evita preflight
        redirect: 'follow',
        body: JSON.stringify(payload)
      });
      const txt = await resp.text();
      let data = {};
      try { data = JSON.parse(txt); } catch {}

      if (resp.ok && data.ok) {
        alert('Enviado correctamente.' + (data.radicado ? '\nRADICADO: ' + data.radicado : ''));
        form.reset();
      } else {
        alert('No se pudo enviar el registro.\n' + (data.error || ('HTTP ' + resp.status)));
      }
    } catch (err) {
      alert('No se pudo enviar el registro.\n' + (err && err.message ? err.message : err));
    }
  });

  /* ========== BOT√ìN ‚ÄúConsultar‚Äù (si est√°s usando uno) ========== */
  const btnConsultar = Array.from(document.querySelectorAll('button'))
    .find(b => (b.textContent || '').trim().toLowerCase() === 'consultar');
  const campoConsulta =
    document.getElementById('consultaNumero') ||
    document.getElementById('consultaQ') ||
    getFieldByLabel(form, 'Ingrese Radicado, MIN o C√©dula');

  if (btnConsultar && campoConsulta) {
    btnConsultar.addEventListener('click', async () => {
      const q = String(campoConsulta.value || '').trim();
      if (!q) { alert('Ingresa un valor para consultar.'); return; }
      try {
        const r = await fetch(`${SCRIPT_URL}?q=${encodeURIComponent(q)}`);
        const t = await r.text();
        const j = JSON.parse(t);
        alert(j.ok ? 'Consulta OK:\n' + JSON.stringify(j.data || j, null, 2)
                   : 'No encontrado: ' + (j.error || ''));
      } catch {
        alert('Error consultando el caso.');
      }
    });
  }

  /* ========== BOT√ìN ‚ÄúExportar XLSX‚Äù (si existe y configuras SHEET_ID) ========== */
  const btnExport = Array.from(document.querySelectorAll('button'))
    .find(b => (b.textContent || '').trim().toLowerCase().includes('exportar xlsx'));
  if (btnExport) {
    btnExport.addEventListener('click', () => {
      if (!SHEET_ID) {
        alert('Configura el SHEET_ID en el script para habilitar la exportaci√≥n a XLSX.');
        return;
      }
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;
      window.open(url, '_blank');
    });
  }
})();
</script>
