
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Formulario Correcci√≥n de datos reagendamiento entregas Sim Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --claro-red:#E60000; --claro-dark:#333; --bg:#f7f7f7; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--claro-dark)}
    header{background:var(--claro-red);color:#fff;padding:16px}
    main{max-width:900px;margin:24px auto;background:#fff;border-radius:12px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h1,h3,h4{margin:0 0 12px}
    label{font-weight:700;margin-bottom:6px;display:block}
    input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px}
    textarea{min-height:96px}
    small{color:#666;display:block;margin-top:6px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .full{grid-column:1/-1}
    .actions{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap}
    button{background:var(--claro-red);color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
    button.secondary{background:#eee;color:#333}
    .status{margin-top:12px;font-weight:700}
    .radicado{margin-top:12px;background:#f0fff0;border:1px solid #b6e3b6;padding:12px;border-radius:8px;display:none}
    pre{background:#fafafa;padding:12px;border:1px solid #eee;border-radius:8px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    #hidden_iframe { width:0;height:0;border:0;position:absolute;left:-9999px; }
  </style>
</head>
<body>
  <header>
    <strong>Formulario Correcci√≥n de datos reagendamiento entregas Sim Card</strong>
  </header>

  <main>
    <h3>Formulario Correcci√≥n datos reagendamiento entregas Sim Card</h3>

    <!-- FORMULARIO: conserva r√≥tulos, orden y reglas tal como en tu ejemplo -->
    <form id="formSim" novalidate>
      <div class="grid">
        <!-- N√∫mero a portar -->
        <div>
          <label for="numeroPortar">N√∫mero a portar</label>
          <input id="numeroPortar" name="numeroPortar" inputmode="numeric" pattern="^\d{10}$" maxlength="10" required />
          <small>El N√∫mero a portar debe ser num√©rico y tener exactamente 10 d√≠gitos.</small>
        </div>

        <!-- C√©dula -->
        <div>
          <label for="cedula">C√©dula</label>
          <input id="cedula" name="cedula" inputmode="numeric" pattern="^\d+$" required />
          <small>La c√©dula debe contener √∫nicamente n√∫meros.</small>
        </div>

        <!-- Nombre Completo -->
        <div class="full">
          <label for="nombreCompleto">Nombre Completo</label>
          <input id="nombreCompleto" name="nombreCompleto" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$" required />
          <small>El nombre debe contener solo letras y espacios.</small>
        </div>

        <!-- Direcci√≥n Completa -->
        <div class="full">
          <label for="direccionCompleta">Direcci√≥n Completa</label>
          <input id="direccionCompleta" name="direccionCompleta" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±0-9#\\-\\./\\/ ]+$" required />
          <small>Incluye complementos: apartamento, torre, bloque, piso, etc. La direcci√≥n debe ser alfanum√©rica y puede incluir #, -, ., /.</small>
        </div>

        <!-- Barrio -->
        <div>
          <label for="barrio">Barrio</label>
          <input id="barrio" name="barrio" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±0-9 ]+$" required />
          <small>El barrio debe ser alfanum√©rico (letras y n√∫meros).</small>
        </div>

        <!-- Ciudad -->
        <div>
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" name="ciudad" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$" required />
        </div>

        <!-- Departamento -->
        <div>
          <label for="departamento">Departamento</label>
          <input id="departamento" name="departamento" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$" required />
          <small>El departamento debe contener solo letras y espacios.</small>
        </div>

        <!-- Ventana de Cambio -->
        <div>
          <label for="ventanaCambio">Ventana de Cambio (dd/mm/aaaa)</label>
          <input id="ventanaCambio" name="ventanaCambio" placeholder="dd/mm/aaaa"
                 pattern="^(0[1-9]|[12][0-9]|3[01])/(0[1-9]|1[0-2])/\\d{4}$" required />
          <small>Formato de fecha inv√°lido. Usa dd/mm/aaaa.</small>
        </div>

        <!-- ICCID -->
        <div>
          <label for="iccid">ICCID (20 d√≠gitos y debe iniciar con 8957101)</label>
          <input id="iccid" name="iccid" inputmode="numeric" pattern="^8957101\\d{13}$" maxlength="20" required />
          <small>El ICCID debe ser num√©rico, iniciar con 8957101 y tener 20 d√≠gitos.</small>
        </div>

        <!-- # DE CONTACTO -->
        <div>
          <label for="contacto"># DE CONTACTO</label>
          <input id="contacto" name="contacto" inputmode="numeric" pattern="^\\d{10}$" maxlength="10" required />
          <small>Debe ser un n√∫mero distinto al N√∫mero a portar.</small>
        </div>

        <!-- Observaciones -->
        <div class="full">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" name="observaciones" placeholder="Comentarios opcionales"></textarea>
        </div>
      </div>

      <!-- BOTONES -->
      <div class="actions">
        <button type="submit">Guardar y Enviar</button>
        <button type="reset" class="secondary">Cancelar</button>
      </div>

      <!-- Estado y radicado mostrado al usuario -->
      <div id="status" class="status" aria-live="polite"></div>
      <div id="radBox" class="radicado"><span id="radTxt"></span></div>

      <!-- Bloque ‚ÄúVer Descargas‚Äù y ‚ÄúConsulta de Caso‚Äù, preservados -->
      <div style="margin-top:16px"><strong>Ver Descargas</strong></div>

      <h4>Consulta de Caso</h4>
      <div class="grid">
        <div>
          <label for="consultaQ">Ingrese Radicado, MIN o C√©dula</label>
          <input id="consultaQ" />
        </div>
        <div style="align-self:end">
          <button id="btnConsultar" type="button" class="secondary">Consultar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btnExport" type="button" class="secondary">Exportar XLSX</button>
      </div>

      <pre id="resultadoConsulta"></pre>
    </form>

    <!-- Plan B: iframe oculto para POST cl√°sico sin CORS (si el navegador bloquea fetch) -->
    <iframe id="hidden_iframe" name="hidden_iframe"></iframe>
    <form id="fallbackForm" action="" method="POST" target="hidden_iframe" style="display:none">
      <input type="hidden" name="json" id="fallbackJson">
    </form>
  </main>

  <script>
    /* ===================== CONFIGURACI√ìN ===================== */
    // Tu Web App (URL /exec reci√©n desplegada)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXTxp8tNTtq5AcTtYINxwgW4184AR3QXhXDtaEAG2_kATnvWGjW7zKCLdEIkTPTBJWuA/exec';

    // (Opcional) ID del Google Sheet para exportar a XLSX
    const SHEET_ID   = ''; // Ej.: '1AbCDEF...xyz'. Si no lo tienes, deja vac√≠o; no afecta el env√≠o.

    /* ===================== L√ìGICA DEL FORMULARIO ===================== */
    const form     = document.getElementById('formSim');
    const statusEl = document.getElementById('status');
    const radBox   = document.getElementById('radBox');
    const radTxt   = document.getElementById('radTxt');
    const resultado= document.getElementById('resultadoConsulta');

    // Arma payload con nombres normalizados y tambi√©n con r√≥tulos originales (labels)
    function buildPayload() {
      const numeroPortar = document.getElementById('numeroPortar').value.trim();
      const contacto     = document.getElementById('contacto').value.trim();

      const data = {
        // üéØ Claves normalizadas (Apps Script/JSON):
        numeroPortar,
        cedula: document.getElementById('cedula').value.trim(),
        nombreCompleto: document.getElementById('nombreCompleto').value.trim(),
        direccionCompleta: document.getElementById('direccionCompleta').value.trim(),
        barrio: document.getElementById('barrio').value.trim(),
        ciudad: document.getElementById('ciudad').value.trim(),
        departamento: document.getElementById('departamento').value.trim(),
        ventanaCambio: document.getElementById('ventanaCambio').value.trim(),
        iccid: document.getElementById('iccid').value.trim(),
        contacto,
        observaciones: document.getElementById('observaciones').value.trim()
      };

      // üè∑Ô∏è Tambi√©n env√≠a los r√≥tulos originales por si tu backend los usa tal cual
      data.labels = {
        'N√∫mero a portar': data.numeroPortar,
        'C√©dula': data.cedula,
        'Nombre Completo': data.nombreCompleto,
        'Direcci√≥n Completa': data.direccionCompleta,
        'Barrio': data.barrio,
        'Ciudad': data.ciudad,
        'Departamento': data.departamento,
        'Ventana de Cambio (dd/mm/aaaa)': data.ventanaCambio,
        'ICCID (20 d√≠gitos y debe iniciar con 8957101)': data.iccid,
        '# DE CONTACTO': data.contacto,
        'Observaciones': data.observaciones
      };

      return data;
    }

    // Env√≠o principal (fetch) y plan B (iframe) para m√°xima compatibilidad
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      statusEl.textContent = '';
      radBox.style.display = 'none';
      radTxt.textContent = '';

      // Validaciones nativas HTML5
      if (!form.reportValidity()) {
        statusEl.textContent = 'Por favor corrige los campos marcados.';
        return;
      }

      // Validaci√≥n adicional: contacto ‚â† n√∫mero a portar
      const numeroPortar = document.getElementById('numeroPortar').value.trim();
      const contacto     = document.getElementById('contacto').value.trim();
      if (numeroPortar === contacto) {
        statusEl.textContent = 'El # de contacto debe ser distinto al N√∫mero a portar.';
        document.getElementById('contacto').focus();
        return;
      }

      const payload = buildPayload();

      try {
        statusEl.textContent = 'Enviando‚Ä¶';

        // Patr√≥n que evita preflight CORS en la mayor√≠a de casos
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          redirect: 'follow',
          body: JSON.stringify(payload)
        });

        const bodyText = await resp.text();
        let j = {};
        try { j = JSON.parse(bodyText); } catch {}

        if (resp.ok && j.ok) {
          statusEl.textContent = '‚úÖ Guardado correctamente.';
          if (j.radicado) {
            radTxt.textContent = `Tu RADICADO es: ${j.radicado}`;
            radBox.style.display = 'block';
          }
          form.reset();
        } else {
          // Si el servidor devolvi√≥ error, lo mostramos
          statusEl.textContent = '‚ùå ' + (j.error || `Error HTTP ${resp.status}`);
          // (Opcional) Fallback si quieres intentar guardado cl√°sico:
          // fallbackPost(payload);
        }
      } catch (error) {
        console.error('[fetch error]', error);
        statusEl.textContent = '‚ùå No se pudo enviar (conexi√≥n).';
        // Intento alternativo sin CORS:
        fallbackPost(payload);
      }
    });

    // Plan B: POST cl√°sico con iframe oculto (evita CORS)
    function fallbackPost(payload) {
      const fb = document.getElementById('fallbackForm');
      const fbJson = document.getElementById('fallbackJson');
      fb.action = SCRIPT_URL;
      fbJson.value = JSON.stringify(payload);
      fb.submit();
      alert('Se intent√≥ env√≠o alternativo. Verifica la hoja en unos segundos.');
    }

    // Consulta de Caso: admite Radicado, MIN o C√©dula en un √∫nico campo
    document.getElementById('btnConsultar').addEventListener('click', async () => {
      const q = document.getElementById('consultaQ').value.trim();
      if (!q) { resultado.textContent = 'Ingresa un valor para consultar.'; return; }
      resultado.textContent = 'Consultando‚Ä¶';
      try {
        const r = await fetch(`${SCRIPT_URL}?q=${encodeURIComponent(q)}`);
        const t = await r.text();
        const j = JSON.parse(t);
        resultado.textContent = j.ok ? JSON.stringify(j.data || j, null, 2) : ('No encontrado: ' + (j.error || ''));
      } catch {
        resultado.textContent = 'Error consultando el caso.';
      }
    });

    // Exportar XLSX (si configuras SHEET_ID)
    document.getElementById('btnExport').addEventListener('click', () => {
      if (!SHEET_ID) { alert('Configura el SHEET_ID en el c√≥digo para habilitar la exportaci√≥n.'); return; }
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;
      window.open(url, '_blank');
    });
  </script>
</body>
</html>
