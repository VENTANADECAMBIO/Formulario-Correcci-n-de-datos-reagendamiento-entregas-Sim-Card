
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Formulario Corrección de datos reagendamiento entregas Sim Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Estilo mínimo, corporativo, sin alterar la estructura textual original -->
  <style>
    :root { --claro-red:#E60000; --claro-dark:#333; --bg:#f7f7f7; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--claro-dark)}
    header{background:var(--claro-red);color:#fff;padding:16px}
    main{max-width:900px;margin:24px auto;background:#fff;border-radius:12px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h1,h3,h4{margin:0 0 12px}
    label{font-weight:700;margin-bottom:6px;display:block}
    input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px}
    textarea{min-height:96px}
    small{color:#666;display:block;margin-top:6px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .full{grid-column:1/-1}
    .actions{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap}
    button{background:var(--claro-red);color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
    button.secondary{background:#eee;color:#333}
    .status{margin-top:12px;font-weight:700}
    .radicado{margin-top:12px;background:#f0fff0;border:1px solid #b6e3b6;padding:12px;border-radius:8px;display:none}
    pre{background:#fafafa;padding:12px;border:1px solid #eee;border-radius:8px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <strong>Formulario Corrección de datos reagendamiento entregas Sim Card</strong>
  </header>

  <main>
    <h3>Formulario Corrección datos reagendamiento entregas Sim Card</h3>

    <!-- Formulario funcional: respeta nombres y reglas del ejemplo -->
    <form id="formSim" novalidate>
      <div class="grid">
        <!-- Número a portar -->
        <div>
          <label for="numeroPortar">Número a portar</label>
          <input id="numeroPortar" name="numeroPortar" inputmode="numeric" pattern="^\d{10}$" maxlength="10" required />
          <small>El Número a portar debe ser numérico y tener exactamente 10 dígitos.</small>
        </div>

        <!-- Cédula -->
        <div>
          <label for="cedula">Cédula</label>
          <input id="cedula" name="cedula" inputmode="numeric" pattern="^\d+$" required />
          <small>La cédula debe contener únicamente números.</small>
        </div>

        <!-- Nombre Completo -->
        <div class="full">
          <label for="nombreCompleto">Nombre Completo</label>
          <input id="nombreCompleto" name="nombreCompleto" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$" required />
          <small>El nombre debe contener solo letras y espacios.</small>
        </div>

        <!-- Dirección Completa -->
        <div class="full">
          <label for="direccionCompleta">Dirección Completa</label>
          <input id="direccionCompleta" name="direccionCompleta" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9#\\-\\./\\/ ]+$" required />
          <small>Incluye complementos: apartamento, torre, bloque, piso, etc. La dirección debe ser alfanumérica y puede incluir #, -, ., /.</small>
        </div>

        <!-- Barrio -->
        <div>
          <label for="barrio">Barrio</label>
          <input id="barrio" name="barrio" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9 ]+$" required />
          <small>El barrio debe ser alfanumérico (letras y números).</small>
        </div>

        <!-- Ciudad -->
        <div>
          <label for="ciudad">Ciudad</label>
          <input id="ciudad" name="ciudad" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$" required />
        </div>

        <!-- Departamento -->
        <div>
          <label for="departamento">Departamento</label>
          <input id="departamento" name="departamento" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$" required />
          <small>El departamento debe contener solo letras y espacios.</small>
        </div>

        <!-- Ventana de Cambio -->
        <div>
          <label for="ventanaCambio">Ventana de Cambio (dd/mm/aaaa)</label>
          <input id="ventanaCambio" name="ventanaCambio" placeholder="dd/mm/aaaa"
                 pattern="^(0[1-9]|[12][0-9]|3[01])/(0[1-9]|1[0-2])/\\d{4}$" required />
          <small>Formato de fecha inválido. Usa dd/mm/aaaa.</small>
        </div>

        <!-- ICCID -->
        <div>
          <label for="iccid">ICCID (20 dígitos y debe iniciar con 8957101)</label>
          <input id="iccid" name="iccid" inputmode="numeric" pattern="^8957101\\d{13}$" maxlength="20" required />
          <small>El ICCID debe ser numérico, iniciar con 8957101 y tener 20 dígitos.</small>
        </div>

        <!-- # DE CONTACTO -->
        <div>
          <label for="contacto"># DE CONTACTO</label>
          <input id="contacto" name="contacto" inputmode="numeric" pattern="^\\d{10}$" maxlength="10" required />
          <small>Debe ser un número distinto al Número a portar.</small>
        </div>

        <!-- Observaciones -->
        <div class="full">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" name="observaciones" placeholder="Comentarios opcionales"></textarea>
        </div>
      </div>

      <!-- Botones principales -->
      <div class="actions">
        <button type="submit">Guardar y Enviar</button>
        <button type="reset" class="secondary">Cancelar</button>
      </div>

      <!-- Estado y radicado -->
      <div id="status" class="status" aria-live="polite"></div>
      <div id="radBox" class="radicado"><span id="radTxt"></span></div>

      <!-- Bloque “Ver Descargas” y Consulta de Caso (como el ejemplo) -->
      <div style="margin-top:16px"><strong>Ver Descargas</strong></div>

      <h4>Consulta de Caso</h4>
      <div class="grid">
        <div>
          <label for="consultaNumero">Número a portar</label>
          <input id="consultaNumero" inputmode="numeric" pattern="^\\d{10}$" maxlength="10" />
        </div>
        <div style="align-self:end">
          <button id="btnConsultar" type="button" class="secondary">Consultar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="btnExport" type="button" class="secondary">Exportar XLSX</button>
      </div>

      <pre id="resultadoConsulta"></pre>
    </form>
  </main>

  <script>
    /* === Integración con tu Google Sheets (Apps Script Web App) === */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrH00LGUnIDglUf71xbhS9aewygODAmR_bLos5xpSKKHMweC3FparniO6-8KkvzBbGAg/exec';
    // (Opcional) ID del Google Sheet para exportar a XLSX. Si no lo tienes, deja vacío.
    const SHEET_ID = ''; // Ej.: '1AbCDEF...xyz'

    const form     = document.getElementById('formSim');
    const statusEl = document.getElementById('status');
    const radBox   = document.getElementById('radBox');
    const radTxt   = document.getElementById('radTxt');

    // Envío del formulario (respeta nombres y reglas)
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      statusEl.textContent = '';
      radBox.style.display = 'none';
      radTxt.textContent = '';

      // Validaciones nativas HTML5
      if (!form.reportValidity()) {
        statusEl.textContent = 'Por favor corrige los campos marcados.';
        return;
      }

      // Validación adicional: contacto ≠ número a portar
      const numeroPortar = document.getElementById('numeroPortar').value.trim();
      const contacto     = document.getElementById('contacto').value.trim();
      if (numeroPortar === contacto) {
        statusEl.textContent = 'El # de contacto debe ser distinto al Número a portar.';
        document.getElementById('contacto').focus();
        return;
      }

      // Payload con nombres exactos del ejemplo
      const payload = {
        numeroPortar,
        cedula: document.getElementById('cedula').value.trim(),
        nombreCompleto: document.getElementById('nombreCompleto').value.trim(),
        direccionCompleta: document.getElementById('direccionCompleta').value.trim(),
        barrio: document.getElementById('barrio').value.trim(),
        ciudad: document.getElementById('ciudad').value.trim(),
        departamento: document.getElementById('departamento').value.trim(),
        ventanaCambio: document.getElementById('ventanaCambio').value.trim(),
        iccid: document.getElementById('iccid').value.trim(),
        contacto,
        observaciones: document.getElementById('observaciones').value.trim()
      };

      try {
        statusEl.textContent = 'Enviando…';

        // Patrón de fetch común para Apps Script (evita preflight CORS en la mayoría de casos)
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          redirect: 'follow',
          body: JSON.stringify(payload)
        });

        const txt = await resp.text();
        let j = {};
        try { j = JSON.parse(txt); } catch {}

        if (j.ok) {
          statusEl.textContent = '✅ Guardado correctamente.';
          if (j.radicado) {
            radTxt.textContent = `Tu RADICADO es: ${j.radicado}`;
            radBox.style.display = 'block';
          }
          form.reset();
        } else {
          statusEl.textContent = '❌ Error al guardar: ' + (j.error || 'Desconocido');
        }
      } catch (error) {
        console.error(error);
